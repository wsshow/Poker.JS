<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>poker</title>
    <link rel="stylesheet" href="https://cdn.staticfile.org/bulma/0.9.4/css/bulma.min.css">
</head>

<body>
    <div id="clock" class="control" style="display: none;">
        <div class="tags has-addons">
            <span class="tag is-link">剩余出牌时间(秒)</span>
            <span id="clock-t" class="tag is-danger">30</span>
        </div>
    </div>
    <div id="wait-show"></div>
    <div id="self-show-card"></div>
    <div id="left-show-card"></div>
    <div id="right-show-card"></div>
    <div id="self-button-group">
        <button class="button is-info" id="playCard">出牌</button>
        <button class="button is-warning" id="playCancel">取消</button>
        <button class="button is-danger" id="playNone">不出</button>
    </div>
    <div id="self-info">
        <div class="control">
            <div class="tags has-addons">
                <span class="tag is-dark">身份</span>
                <span class="tag is-info">地主</span>
            </div>
        </div>
        <div class="control">
            <div class="tags has-addons">
                <span class="tag is-dark">资金</span>
                <span class="tag is-info">1200万</span>
            </div>
        </div>
        <div class="control">
            <div class="tags has-addons">
                <span class="tag is-dark">牌数</span>
                <span class="tag is-info">17</span>
            </div>
        </div>
        <div class="control">
            <div class="tags has-addons">
                <span class="tag is-dark">昵称</span>
                <span class="tag is-info">跳跳虎</span>
            </div>
        </div>
        <div class="control">
            <div class="tags has-addons">
                <span class="tag is-dark">称号</span>
                <span class="tag is-info">国王</span>
            </div>
        </div>
    </div>
    <div id="container-self"></div>
    <div id="container-left">
        <div class="control">
            <div class="tags has-addons">
                <span class="tag is-info">农民</span>
                <span class="tag is-dark">身份</span>
            </div>
        </div>
        <div class="control">
            <div class="tags has-addons">
                <span class="tag is-info">200万</span>
                <span class="tag is-dark">资金</span>
            </div>
        </div>
        <div class="control">
            <div class="tags has-addons">
                <span class="tag is-info">17</span>
                <span class="tag is-dark">牌数</span>
            </div>
        </div>
        <div class="control">
            <div class="tags has-addons">
                <span class="tag is-info">哆啦A梦</span>
                <span class="tag is-dark">昵称</span>
            </div>
        </div>
        <div class="control">
            <div class="tags has-addons">
                <span class="tag is-info">亲王</span>
                <span class="tag is-dark">称号</span>
            </div>
        </div>
    </div>
    <div id="container-right">
        <div class="control">
            <div class="tags has-addons">
                <span class="tag is-dark">身份</span>
                <span class="tag is-info">农民</span>
            </div>
        </div>
        <div class="control">
            <div class="tags has-addons">
                <span class="tag is-dark">资金</span>
                <span class="tag is-info">120万</span>
            </div>
        </div>
        <div class="control">
            <div class="tags has-addons">
                <span class="tag is-dark">牌数</span>
                <span class="tag is-info">17</span>
            </div>
        </div>
        <div class="control">
            <div class="tags has-addons">
                <span class="tag is-dark">昵称</span>
                <span class="tag is-info">小熊维尼</span>
            </div>
        </div>
        <div class="control">
            <div class="tags has-addons">
                <span class="tag is-dark">称号</span>
                <span class="tag is-info">大学士</span>
            </div>
        </div>
    </div>
</body>
<style>
    * {
        margin: 0;
        padding: 0
    }

    .control {
        margin-top: 1px;
    }

    #self-info {
        width: 120px;
        height: 120px;
        position: absolute;
    }

    #container-self {
        width: 570px;
        height: 120px;
        position: absolute;
    }

    #container-left {
        width: 120px;
        height: 120px;
        position: absolute;
        /* border: 1px solid skyblue; */
    }

    #container-left .control {
        float: right;
    }

    #container-right {
        width: 120px;
        height: 120px;
        position: absolute;
        /* border: 1px solid orange; */
    }

    #self-button-group {
        position: absolute;
    }

    #self-show-card {
        width: 570px;
        height: 60px;
        position: absolute;
    }

    #left-show-card {
        width: 570px;
        height: 60px;
        position: absolute;
    }

    #right-show-card {
        width: 570px;
        height: 60px;
        position: absolute;
    }

    .card-selected {
        transform: translateY(-16px);
    }

    .unselectable {
        -moz-user-select: -moz-none;
        -khtml-user-select: none;
        -webkit-user-select: none;
        -o-user-select: none;
        user-select: none;
    }
</style>
<script src="../release/poker.min.js"></script>
<script type="module">
    import Enumerable from 'https://cdn.bootcdn.net/ajax/libs/linq.js/4.0.1/linq.js'
    if (window.Poker) {

        class Card {
            constructor(point, suit, img, value) {
                this.Point = point;
                this.Suit = suit;
                this.Img = img;
                this.Value = value;
            }
        }

        let mapValue = {
            '3': 3,
            '4': 4,
            '5': 5,
            '6': 6,
            '7': 7,
            '8': 8,
            '9': 9,
            '10': 10,
            'j': 11,
            'q': 12,
            'k': 13,
            'a': 14,
            '2': 15,
            'jokers': 16,
            'jokerh': 17,
        }

        let mapPlayCardType = {
            'DanZhang': '单张',
            'DuiZi': '对子',
            'SanBuDai': '三不带',
            'SanDaiYi': '三带一',
            'SanDaiEr': '三带二',
            'ShunZi': '顺子',
            'LianDui': '连对',
            'FeiJi': '飞机',
            'ZhaDan': '炸弹',
            'SiDaiEr': '四带二',
            'WangZha': '王炸',
            'Unknown': '牌型不符合规范'
        }

        // 生成卡组
        console.time('GenerateCardTime');
        let suits = ['hearts', 'diamonds', 'spades', 'clubs'];
        let points = ['a', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'j', 'q', 'k'];
        let cards = []
        let point, suit, img, card;
        for (const ks in suits) {
            for (const kp in points) {
                point = points[kp]
                suit = suits[ks];
                img = Poker.getCardData(120, suit, point);
                card = new Card(point, suit, img, mapValue[point])
                cards.push(card)
            }
        }
        card = new Card('jokers', 'spades', Poker.getCardData(120, 'spades', 'joker'), mapValue['jokers'])
        cards.push(card)
        card = new Card('jokerh', 'hearts', Poker.getCardData(120, 'hearts', 'joker'), mapValue['jokerh'])
        cards.push(card)
        console.log('cards length:', cards.length);
        console.timeEnd('GenerateCardTime');

        // 洗牌算法
        function Shuffle(arr) {
            let len = arr.length, random
            while (len != 0) {
                random = (Math.random() * len--) >>> 0;
                [arr[len], arr[random]] = [arr[random], arr[len]]
            }
            return arr
        }

        // 洗牌
        console.time('ShuffleTime');
        cards = Shuffle(cards)
        console.timeEnd('ShuffleTime');

        // 展示卡组
        let container = document.getElementById('container-self');
        let nodeImg, bLeftMouseDown = false;
        let cards_A = cards.slice(0, 17);
        cards_A = cards_A.sort((a, b) => {
            return b.Value - a.Value;
        });

        // 选择卡片动作
        function SelectedCard(el) {
            if (el.classList.contains('card-selected')) {
                el.classList.remove('card-selected');
            } else {
                el.classList.add('card-selected');
            }
        }

        for (const k in cards_A) {
            card = cards_A[k]
            nodeImg = document.createElement("img");
            if (k != 0) {
                nodeImg.style.marginLeft = '-60px';
                nodeImg.style.position = 'relative';
                nodeImg.style.zIndex = k;
            }
            nodeImg.src = card.Img;
            nodeImg.title = card.Point + '-' + card.Suit;
            nodeImg.value = card.Value;
            nodeImg.onmousedown = (e) => {
                SelectedCard(e.target);
            };
            nodeImg.onmouseenter = (e) => {
                if (bLeftMouseDown) {
                    SelectedCard(e.target);
                }
            };
            // 禁止图片选中或拖动
            nodeImg.draggable = false;
            nodeImg.classList.add('unselectable');
            container.appendChild(nodeImg)
        }

        let cards_B = cards.slice(17, 34);
        cards_B = cards_B.sort((a, b) => {
            return b.Value - a.Value;
        });
        // cards_B = cards_B.slice(0, 2);
        let leftShowCard = document.getElementById('left-show-card');
        for (const k in cards_B) {
            card = cards_B[k]
            nodeImg = document.createElement("img");
            if (k != 0) {
                nodeImg.style.marginLeft = '-60px';
                nodeImg.style.position = 'relative';
                nodeImg.style.zIndex = k;
            }
            nodeImg.src = card.Img;
            nodeImg.title = card.Point + '-' + card.Suit;
            nodeImg.value = card.Value;
            nodeImg.onmousedown = (e) => {
                SelectedCard(e.target);
            };
            nodeImg.onmouseenter = (e) => {
                if (bLeftMouseDown) {
                    SelectedCard(e.target);
                }
            };
            // 禁止图片选中或拖动
            nodeImg.draggable = false;
            nodeImg.classList.add('unselectable');
            leftShowCard.appendChild(nodeImg)
        }
        leftShowCard.style.transform = 'rotate(90deg)'

        let cards_C = cards.slice(34, 51);
        cards_C = cards_C.sort((a, b) => {
            return b.Value - a.Value;
        });
        // cards_C = cards_C.slice(0, 2);
        let rightShowCard = document.getElementById('right-show-card');
        for (const k in cards_C) {
            card = cards_C[k]
            nodeImg = document.createElement("img");
            if (k != 0) {
                nodeImg.style.marginLeft = '-60px';
                nodeImg.style.position = 'relative';
                nodeImg.style.zIndex = k;
            }
            nodeImg.src = card.Img;
            nodeImg.title = card.Point + '-' + card.Suit;
            nodeImg.value = card.Value;
            nodeImg.onmousedown = (e) => {
                SelectedCard(e.target);
            };
            nodeImg.onmouseenter = (e) => {
                if (bLeftMouseDown) {
                    SelectedCard(e.target);
                }
            };
            // 禁止图片选中或拖动
            nodeImg.draggable = false;
            nodeImg.classList.add('unselectable');
            rightShowCard.appendChild(nodeImg)
        }
        rightShowCard.style.transform = 'rotate(-90deg)'

        document.onmousedown = (e) => {
            bLeftMouseDown = true;
        }

        document.onmouseup = (e) => {
            bLeftMouseDown = false;
        }

        // 禁止全局右键菜单
        document.oncontextmenu = () => false;

        // 出牌倒计时
        function CardClock() {
            let eleClock = document.getElementById('clock');
            eleClock.style.display = '';
            let eleClockT = document.getElementById('clock-t');
            let tm = 30;
            let intervalID = window.setInterval(() => {
                if (--tm == 0) {
                    clearInterval(intervalID)
                    eleClock.style.display = 'none';
                }
                eleClockT.innerHTML = tm;
            }, 1000);
        }

        // 出牌规则检测
        function PlayCardCheck(cards) {
            let selectedCardCount = cards.length;

            // 单张
            if (selectedCardCount == 1) {
                return 'DanZhang';
            }

            // 对子
            if (selectedCardCount == 2 && cards[0] == cards[1]) {
                return 'DuiZi';
            }

            // 按值分组
            let gs = Enumerable.from(cards).groupBy(card => card);
            let gsCount = gs.count();

            // 三不带
            if (selectedCardCount == 3 && gsCount == 1) {
                return 'SanBuDai';
            }

            // 三带一
            if (selectedCardCount == 4 && (gs.where(a => a.count() == 3).count() == 1)) {
                return 'SanDaiYi';
            }

            // 三带二
            if ((selectedCardCount == 5) && (gsCount == 2)
                && (gs.where(a => a.count() == 3).count() == 1)) {
                return 'SanDaiEr';
            }


            // 顺子
            if (selectedCardCount >= 5 && selectedCardCount == gsCount) {
                cards = cards.sort((a, b) => a > b);
                if ((cards[0] - cards[selectedCardCount - 1]) == (selectedCardCount - 1)) {
                    return 'ShunZi'
                }
            }

            // 连对
            if (selectedCardCount >= 6 && (gs.where(a => a.count() == 2).count() == gsCount)) {
                cards = cards.sort((a, b) => a > b);
                if ((cards[0] - cards[selectedCardCount - 1]) == (gsCount - 1)) {
                    return 'LianDui'
                }
            }

            // 飞机
            if (selectedCardCount >= 6) {
                let g3Count = gs.where(a => a.count() == 3).count();
                if (selectedCardCount == g3Count * 4 || selectedCardCount == g3Count * 5) {
                    return 'FeiJi';
                }
            }

            // 炸弹
            if (selectedCardCount == 4 && gsCount == 1) {
                return 'ZhaDan';
            }

            // 四带二
            if ((selectedCardCount == 6 || selectedCardCount == 8)
                && (gs.where(a => a.count() == 4).count() == 1)
                && (gsCount == 2 || gsCount == 3)) {
                return 'SiDaiEr';
            }

            // 王炸
            if (selectedCardCount == 2 && (cards[0] + cards[1]) == 33) {
                return 'WangZha';
            }
            return 'Unknown';
        }

        window.onload = function () {

            // 监听玩家出牌事件
            document.getElementById('playCard').addEventListener('click', () => {
                let selfShowCard = document.getElementById('self-show-card');
                selfShowCard.innerHTML = '';
                let playCards = document.querySelectorAll('img.card-selected');

                // 检测牌型
                let arrPlayCards = [];
                for (const nodeImg of playCards) {
                    arrPlayCards.push(parseInt(nodeImg.value));
                }
                let playCardType = PlayCardCheck(arrPlayCards);
                console.log(mapPlayCardType[playCardType]);
                if (playCardType == 'Unknown') {
                    return
                }

                // 出牌动画
                for (let nodeImg of playCards) {
                    nodeImg.onmousedown = () => { };
                    nodeImg.onmouseenter = () => { };
                    nodeImg.style.transform = `scale(0.8)`;
                    selfShowCard.appendChild(nodeImg);
                }
            })

            // 监听玩家取消事件
            document.getElementById('playCancel').addEventListener('click', () => {
                let playCards = document.querySelectorAll('img.card-selected');
                for (let nodeImg of playCards) {
                    nodeImg.classList.remove('card-selected');
                }
            })

            function Autosize() {
                let selfCardGroup = document.getElementById('container-self');
                let leftCardGroup = document.getElementById('container-left');
                let rightCardGroup = document.getElementById('container-right');
                let selfCardGroupWidth = selfCardGroup.offsetWidth;
                let selfCardGroupHeight = selfCardGroup.offsetHeight;
                let posLeft = (document.documentElement.clientWidth - selfCardGroupWidth) >> 1;
                let posTop = (document.documentElement.clientHeight - selfCardGroupHeight) >> 1;

                // 设置牌组放置位置
                selfCardGroup.style.left = posLeft + 'px';
                selfCardGroup.style.top = 1.98 * posTop + 'px';

                leftCardGroup.style.left = '0px';
                leftCardGroup.style.top = 0.5 * posTop + 'px';

                rightCardGroup.style.left = `${document.documentElement.clientWidth - rightCardGroup.offsetWidth}px`;
                rightCardGroup.style.top = 0.5 * posTop + 'px';

                // 设置自身信息位置
                let selfInfo = document.getElementById('self-info');
                selfInfo.style.left = '0px';
                selfInfo.style.top = 1.98 * posTop + 'px';

                // 设置按钮组位置
                let selfButtonGroup = document.getElementById('self-button-group');
                selfButtonGroup.style.left = selfCardGroup.style.left;
                selfButtonGroup.style.top = `${parseInt(selfCardGroup.style.top, 10) - 2 * selfButtonGroup.offsetHeight}px`;
                selfButtonGroup.style.width = selfCardGroup.offsetWidth + 'px';

                // 计算并设置按钮间隔距离
                let buttons = document.querySelectorAll('button');
                let intervalOfButton = ((selfCardGroup.offsetWidth - 300) - 3 * buttons[0].offsetWidth) >> 1;
                buttons[0].style.marginLeft = '150px';
                buttons[1].style.marginLeft = `${intervalOfButton}px`;
                buttons[2].style.marginLeft = `${intervalOfButton}px`;

                // 设置自己出牌展示区位置
                let selfShowCard = document.getElementById('self-show-card');
                selfShowCard.style.left = `${posLeft}px`;
                selfShowCard.style.top = `${parseInt(selfButtonGroup.style.top, 10) - 1.2 * selfCardGroupHeight}px`;

                // 设置左边玩家出牌展示区位置
                let leftShowCard = document.getElementById('left-show-card');
                leftShowCard.style.left = '0px';
                leftShowCard.style.top = `${0.7 * posTop}px`;

                // 设置右边玩家出牌展示区位置
                let rightShowCard = document.getElementById('right-show-card');
                rightShowCard.style.left = `${document.documentElement.clientWidth - selfCardGroupWidth}px`;
                rightShowCard.style.top = `${0.7 * posTop}px`;

                // 设置自己定时器的位置
                let eleClock = document.getElementById('clock');
                eleClock.style.left = 0.9 * posLeft + 'px'
                eleClock.style.top = `${parseInt(selfButtonGroup.style.top, 10) + 5}px`;
            }

            Autosize();
            CardClock();

            //当浏览器页面发生改变时自适应
            window.onresize = () => Autosize();
        }
    } else {
        document.body.innerHTML = 'This browser does not support canvas.';
    }
</script>

</html>