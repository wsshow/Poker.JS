<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>poker</title>
    <link rel="stylesheet" href="https://cdn.staticfile.org/bulma/0.9.4/css/bulma.min.css">
</head>

<body>
    <div id="self-show-card"></div>
    <div id="self-button-group">
        <button class="button is-info">出牌</button>
        <button class="button is-warning">取消</button>
        <button class="button is-danger">不出</button>
    </div>
    <div id="container-self"></div>
    <div id="container-left"></div>
    <div id="container-right"></div>
</body>
<style>
    * {
        margin: 0;
        padding: 0
    }

    #container-self {
        width: 540px;
        height: 120px;
        position: absolute;
    }

    #container-left {
        width: 100px;
        height: 100px;
        position: absolute;
        border: 1px solid skyblue;
    }

    #container-right {
        width: 100px;
        height: 100px;
        position: absolute;
        border: 1px solid orange;
    }

    #self-button-group {
        position: absolute;
    }

    .card-selected {
        transform: translateY(-16px);
    }

    .unselectable {
        -moz-user-select: -moz-none;
        -khtml-user-select: none;
        -webkit-user-select: none;
        -o-user-select: none;
        user-select: none;
    }
</style>
<script src="../release/poker.min.js"></script>
<script>

    if (window.Poker) {

        class Card {
            constructor(point, suit, img, value) {
                this.Point = point;
                this.Suit = suit;
                this.Img = img;
                this.Value = value;
            }
        }

        let mapValue = {
            '3': 3,
            '4': 4,
            '5': 5,
            '6': 6,
            '7': 7,
            '8': 8,
            '9': 9,
            '10': 10,
            'j': 11,
            'q': 12,
            'k': 13,
            'a': 14,
            '2': 15,
            'jokers': 16,
            'jokerh': 17,
        }

        // 生成卡组
        console.time('GenerateCardTime');
        let suits = ['hearts', 'diamonds', 'spades', 'clubs'];
        let points = ['a', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'j', 'q', 'k'];
        let cards = []
        let point, suit, img, card;
        for (const ks in suits) {
            for (const kp in points) {
                point = points[kp]
                suit = suits[ks];
                img = Poker.getCardData(120, suit, point);
                card = new Card(point, suit, img, mapValue[point])
                cards.push(card)
            }
        }
        card = new Card('jokers', 'spades', Poker.getCardData(120, 'spades', 'joker'), mapValue['jokers'])
        cards.push(card)
        card = new Card('jokerh', 'hearts', Poker.getCardData(120, 'hearts', 'joker'), mapValue['jokerh'])
        cards.push(card)
        // cards.forEach(card => {
        //     console.log(card);
        // });
        console.log('cards length:', cards.length);
        console.timeEnd('GenerateCardTime');

        // 洗牌算法
        function Shuffle(arr) {
            let len = arr.length, random
            while (len != 0) {
                random = (Math.random() * len--) >>> 0;
                [arr[len], arr[random]] = [arr[random], arr[len]]
            }
            return arr
        }

        // 洗牌
        console.time('ShuffleTime');
        cards = Shuffle(cards)
        console.timeEnd('ShuffleTime');

        // 展示卡组
        let container = document.getElementById('container-self');
        let nodeImg, bLeftMouseDown = false;
        let cards_A = cards.slice(0, 16);
        cards_A = cards_A.sort((a, b) => {
            return b.Value - a.Value;
        });
        // 选择卡片动作
        function SelectedCard(e) {
            if (e.target.classList.contains('card-selected')) {
                e.target.classList.remove('card-selected')
            } else {
                e.target.classList.add('card-selected')
            }
        }
        for (const k in cards_A) {
            card = cards_A[k]
            nodeImg = document.createElement("img");
            if (k != 0) {
                nodeImg.style.marginLeft = '-60px';
                nodeImg.style.position = 'relative';
                nodeImg.style.zIndex = k;
            }
            nodeImg.src = card.Img;
            nodeImg.title = card.Point + '-' + card.Suit;
            nodeImg.value = card.Value;
            nodeImg.onclick = (e) => {
                SelectedCard(e);
            }
            nodeImg.onmouseenter = (e) => {
                if (bLeftMouseDown) {
                    SelectedCard(e);
                }
            };
            // 禁止图片选中或拖动
            nodeImg.draggable = false;
            nodeImg.classList.add('unselectable');
            container.appendChild(nodeImg)
        }

        document.onmousedown = (e) => {
            bLeftMouseDown = true;
        }
        document.onmouseup = (e) => {
            bLeftMouseDown = false;
        }
        // 禁止全局右键菜单
        document.oncontextmenu = () => false;
    } else {
        document.body.innerHTML = 'This browser does not support canvas.';
    }
</script>
<script>
    window.onload = function () {
        function Autosize() {
            var selfCardGroup = document.getElementById('container-self');
            var leftCardGroup = document.getElementById('container-left');
            var rightCardGroup = document.getElementById('container-right');
            var selfCardGroupWidth = selfCardGroup.offsetWidth;
            var selfCardGroupHeight = selfCardGroup.offsetHeight;
            var posLeft = (document.documentElement.clientWidth - selfCardGroupWidth) >> 1;
            var posTop = (document.documentElement.clientHeight - selfCardGroupHeight) >> 1;

            // 设置牌组放置位置
            selfCardGroup.style.left = posLeft + 'px';
            selfCardGroup.style.top = 1.5 * posTop + 'px';

            leftCardGroup.style.left = `${parseInt(selfCardGroup.style.left, 10) - leftCardGroup.offsetWidth}px`;
            leftCardGroup.style.top = 0.5 * posTop + 'px';

            rightCardGroup.style.left = `${parseInt(selfCardGroup.style.left, 10) + selfCardGroupWidth}px`;
            rightCardGroup.style.top = 0.5 * posTop + 'px';

            // 设置按钮组位置
            var selfButtonGroup = document.getElementById('self-button-group');
            selfButtonGroup.style.left = selfCardGroup.style.left;
            selfButtonGroup.style.top = `${parseInt(selfCardGroup.style.top, 10) - 2 * selfButtonGroup.offsetHeight}px`;
            selfButtonGroup.style.width = selfCardGroup.offsetWidth + 'px';

            // 计算并设置按钮间隔距离
            let buttons = document.querySelectorAll('button');
            let intervalOfButton = ((selfCardGroup.offsetWidth - 300) - 3 * buttons[0].offsetWidth) >> 1;
            buttons[0].style.marginLeft = '150px';
            buttons[1].style.marginLeft = `${intervalOfButton}px`;
            buttons[2].style.marginLeft = `${intervalOfButton}px`;
        }
        Autosize();
        //当浏览器页面发生改变时，自适应
        window.onresize = function () {
            Autosize();
        }
    }
</script>

</html>